name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 594ad8871e1e8e45f8e626c015fd611163430207
          doNotCache: true

      - name: Install ArrayFire
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://arrayfire.s3.amazonaws.com/3.9.0/ArrayFire-v3.9.0_Windows_x86_64.exe -OutFile af.exe
          Start-Process -FilePath af.exe -ArgumentList /S -Wait

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake -DCYXWIZ_BUILD_ENGINE=ON -DCYXWIZ_BUILD_SERVER_NODE=ON -DCYXWIZ_BUILD_TESTS=OFF -DCYXWIZ_ENABLE_PYTHON=OFF

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Package
        shell: pwsh
        run: |
          mkdir release
          Copy-Item build/bin/Release/*.exe,build/bin/Release/*.dll release/ -ErrorAction SilentlyContinue
          Compress-Archive release -DestinationPath cyxwiz-windows-x64.zip

      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: "*.zip"

  build-linux:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - run: sudo apt-get update && sudo apt-get install -y build-essential cmake ninja-build pkg-config libgl1-mesa-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libxext-dev libwayland-dev libxkbcommon-dev libgtk-3-dev python3-dev autoconf automake libtool

      - uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 594ad8871e1e8e45f8e626c015fd611163430207
          doNotCache: true

      - name: Install ArrayFire
        run: |
          wget -q https://arrayfire.s3.amazonaws.com/3.9.0/ArrayFire-v3.9.0-Linux-x86_64.sh
          chmod +x ArrayFire-v3.9.0-Linux-x86_64.sh
          sudo ./ArrayFire-v3.9.0-Linux-x86_64.sh --prefix=/opt/arrayfire --skip-license

      - name: Configure
        run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake -DCYXWIZ_BUILD_ENGINE=ON -DCYXWIZ_BUILD_SERVER_NODE=ON -DCYXWIZ_BUILD_TESTS=OFF -DCYXWIZ_ENABLE_PYTHON=OFF -DArrayFire_DIR=/opt/arrayfire/share/ArrayFire/cmake

      - run: cmake --build build --parallel

      - name: Package
        run: |
          mkdir -p release/lib
          cp build/bin/* release/ 2>/dev/null || true
          cp build/lib/*.so* release/lib/ 2>/dev/null || true
          tar -czvf cyxwiz-linux-x64.tar.gz release

      - uses: actions/upload-artifact@v4
        with:
          name: linux
          path: "*.tar.gz"

  build-macos:
    runs-on: macos-14
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - run: brew install cmake ninja pkg-config autoconf automake libtool arrayfire

      - uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 594ad8871e1e8e45f8e626c015fd611163430207
          doNotCache: true

      - name: Configure
        run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake -DCYXWIZ_BUILD_ENGINE=ON -DCYXWIZ_BUILD_SERVER_NODE=ON -DCYXWIZ_BUILD_TESTS=OFF -DCYXWIZ_ENABLE_PYTHON=OFF

      - run: cmake --build build --parallel

      - name: Package
        run: |
          mkdir -p release/lib
          cp build/bin/* release/ 2>/dev/null || true
          cp build/lib/*.dylib release/lib/ 2>/dev/null || true
          zip -r cyxwiz-macos-arm64.zip release

      - uses: actions/upload-artifact@v4
        with:
          name: macos
          path: "*.zip"

  release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - uses: softprops/action-gh-release@v1
        with:
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
