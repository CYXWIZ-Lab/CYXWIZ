# CyxCloud Architecture Blueprint

> **Version**: 1.0.0
> **Status**: Design Phase
> **Last Updated**: December 2024

---

## Table of Contents

1. [System Overview](#1-system-overview)
2. [Component Architecture](#2-component-architecture)
3. [Network Topology](#3-network-topology)
4. [Data Flow Architecture](#4-data-flow-architecture)
5. [Storage Architecture](#5-storage-architecture)
6. [Security Architecture](#6-security-architecture)
7. [API Specifications](#7-api-specifications)
8. [Database Schema](#8-database-schema)
9. [Protocol Specifications](#9-protocol-specifications)
10. [Deployment Architecture](#10-deployment-architecture)
11. [Scalability & Performance](#11-scalability--performance)
12. [Monitoring & Observability](#12-monitoring--observability)

---

## 1. System Overview

### 1.1 High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              CyxCloud Platform                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         CLIENT LAYER                                     │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐            │   │
│  │  │  CyxWiz   │  │   Web     │  │  Mobile   │  │   CLI     │            │   │
│  │  │  Engine   │  │   App     │  │   Apps    │  │   Tool    │            │   │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘            │   │
│  └────────┼──────────────┼──────────────┼──────────────┼────────────────────┘   │
│           │              │              │              │                         │
│           └──────────────┴──────────────┴──────────────┘                         │
│                                    │                                             │
│                          ┌─────────▼─────────┐                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         GATEWAY LAYER                                    │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │   REST API      │  │   gRPC API      │  │  S3-Compatible  │          │   │
│  │  │   (Public)      │  │   (Internal)    │  │   API           │          │   │
│  │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘          │   │
│  │           │                    │                    │                    │   │
│  │           └────────────────────┼────────────────────┘                    │   │
│  │                                │                                         │   │
│  │  ┌─────────────────────────────▼─────────────────────────────────────┐  │   │
│  │  │                    Load Balancer / Router                          │  │   │
│  │  │            (Geographic routing, Rate limiting)                     │  │   │
│  │  └─────────────────────────────┬─────────────────────────────────────┘  │   │
│  └────────────────────────────────┼────────────────────────────────────────┘   │
│                                   │                                             │
│  ┌────────────────────────────────▼────────────────────────────────────────┐   │
│  │                         SERVICE LAYER                                    │   │
│  │                                                                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │   │
│  │  │   Metadata   │  │   Routing    │  │   Access     │  │  Billing    │  │   │
│  │  │   Service    │  │   Service    │  │   Control    │  │  Service    │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘  │   │
│  │                                                                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │   │
│  │  │   Erasure    │  │   Health     │  │   Repair     │  │  Analytics  │  │   │
│  │  │   Encoder    │  │   Monitor    │  │   Service    │  │  Service    │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘  │   │
│  │                                                                          │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                   │                                             │
│  ┌────────────────────────────────▼────────────────────────────────────────┐   │
│  │                         COORDINATION LAYER                               │   │
│  │                                                                          │   │
│  │  ┌────────────────────────────────────────────────────────────────────┐ │   │
│  │  │                    CyxWiz Central Server                            │ │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │ │   │
│  │  │  │    Node     │  │    Job      │  │   Stream    │                 │ │   │
│  │  │  │   Registry  │  │  Scheduler  │  │   Manager   │                 │ │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘                 │ │   │
│  │  └────────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                          │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                   │                                             │
│  ┌────────────────────────────────▼────────────────────────────────────────┐   │
│  │                         STORAGE LAYER (P2P)                              │   │
│  │                                                                          │   │
│  │    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐            │   │
│  │    │ Storage │    │ Storage │    │ Storage │    │ Storage │    ...     │   │
│  │    │ Node 1  │◄──►│ Node 2  │◄──►│ Node 3  │◄──►│ Node N  │            │   │
│  │    │         │    │         │    │         │    │         │            │   │
│  │    │ [Chunks]│    │ [Chunks]│    │ [Chunks]│    │ [Chunks]│            │   │
│  │    └─────────┘    └─────────┘    └─────────┘    └─────────┘            │   │
│  │         │              │              │              │                   │   │
│  │         └──────────────┴──────────────┴──────────────┘                   │   │
│  │                              │                                           │   │
│  │                    ┌─────────▼─────────┐                                │   │
│  │                    │   libp2p DHT      │                                │   │
│  │                    │   (Discovery)     │                                │   │
│  │                    └───────────────────┘                                │   │
│  │                                                                          │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                   │                                             │
│  ┌────────────────────────────────▼────────────────────────────────────────┐   │
│  │                         BLOCKCHAIN LAYER                                 │   │
│  │                                                                          │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│   │
│  │  │                        Solana Blockchain                             ││   │
│  │  │                                                                      ││   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ ││   │
│  │  │  │   Data      │  │   Access    │  │   Payment   │  │   Node     │ ││   │
│  │  │  │  Registry   │  │   Control   │  │   Stream    │  │  Staking   │ ││   │
│  │  │  │  Program    │  │   Program   │  │   Program   │  │  Program   │ ││   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘ ││   │
│  │  └─────────────────────────────────────────────────────────────────────┘│   │
│  │                                                                          │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 Component Summary

| Layer | Components | Responsibility |
|-------|------------|----------------|
| **Client** | Engine, Web, Mobile, CLI | User interfaces for data access |
| **Gateway** | REST, gRPC, S3 APIs | Request routing, authentication |
| **Service** | Metadata, Routing, Encoding | Core business logic |
| **Coordination** | Central Server | Orchestration, scheduling |
| **Storage** | Storage Nodes | Distributed chunk storage |
| **Blockchain** | Solana Programs | Immutable records, payments |

### 1.3 Design Principles

1. **Decentralization First**: No single point of failure
2. **Content Addressing**: Data identified by hash, not location
3. **Erasure Coding**: Efficient redundancy (1.4x vs 3x replication)
4. **Client-Side Encryption**: Zero-knowledge storage
5. **Incentive Alignment**: Economic rewards for good behavior
6. **Ecosystem Integration**: Native CyxWiz compatibility

---

## 2. Component Architecture

### 2.1 Storage Node (cyxcloud-node)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           STORAGE NODE                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          NETWORK MODULE                                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │
│  │  │   libp2p    │  │    QUIC     │  │   gRPC      │  │   Gossip    │  │  │
│  │  │   Host      │  │  Transport  │  │   Server    │  │   Protocol  │  │  │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  │  │
│  │         │                │                │                │          │  │
│  │         └────────────────┴────────────────┴────────────────┘          │  │
│  │                                   │                                    │  │
│  └───────────────────────────────────┼───────────────────────────────────┘  │
│                                      │                                       │
│  ┌───────────────────────────────────▼───────────────────────────────────┐  │
│  │                          REQUEST HANDLER                               │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  PUT Chunk  │  GET Chunk  │  DELETE  │  LIST  │  REPAIR  │  │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────┬───────────────────────────────────┘  │
│                                      │                                       │
│  ┌───────────────────────────────────▼───────────────────────────────────┐  │
│  │                          STORAGE ENGINE                                │  │
│  │                                                                        │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │  │
│  │  │   Chunk Store    │  │   Metadata DB    │  │   Index Store    │    │  │
│  │  │   (RocksDB)      │  │   (sled/SQLite)  │  │   (In-Memory)    │    │  │
│  │  │                  │  │                  │  │                  │    │  │
│  │  │  ┌────────────┐  │  │  ┌────────────┐  │  │  ┌────────────┐  │    │  │
│  │  │  │ SST Files  │  │  │  │ CID→Meta   │  │  │  │ Bloom      │  │    │  │
│  │  │  │ (Chunks)   │  │  │  │ Mapping    │  │  │  │ Filters    │  │    │  │
│  │  │  └────────────┘  │  │  └────────────┘  │  │  └────────────┘  │    │  │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘    │  │
│  │                                                                        │  │
│  └───────────────────────────────────┬───────────────────────────────────┘  │
│                                      │                                       │
│  ┌───────────────────────────────────▼───────────────────────────────────┐  │
│  │                          ERASURE MODULE                                │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │  │
│  │  │   RS Encoder     │  │   RS Decoder     │  │   Shard Manager  │    │  │
│  │  │   (k=10, m=4)    │  │   (Reconstruct)  │  │   (Distribution) │    │  │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘    │  │
│  └───────────────────────────────────┬───────────────────────────────────┘  │
│                                      │                                       │
│  ┌───────────────────────────────────▼───────────────────────────────────┐  │
│  │                          BACKGROUND SERVICES                           │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │  │
│  │  │   Health     │  │   Garbage    │  │   Metrics    │  │  Proof    │ │  │
│  │  │   Reporter   │  │   Collector  │  │   Exporter   │  │  Worker   │ │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └───────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Gateway Service (cyxcloud-gateway)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           GATEWAY SERVICE                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       INGRESS LAYER                                  │   │
│  │                                                                      │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │   │
│  │  │  HTTPS/TLS  │  │   gRPC      │  │  WebSocket  │  │   HTTP/3   │ │   │
│  │  │  (REST)     │  │  (Internal) │  │  (Sync)     │  │   (QUIC)   │ │   │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬─────┘ │   │
│  │         │                │                │                │        │   │
│  │         └────────────────┴────────────────┴────────────────┘        │   │
│  │                                   │                                  │   │
│  └───────────────────────────────────┼─────────────────────────────────┘   │
│                                      │                                      │
│  ┌───────────────────────────────────▼─────────────────────────────────┐   │
│  │                       MIDDLEWARE CHAIN                               │   │
│  │                                                                      │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌──────────┐ │   │
│  │  │  Rate   │─►│  Auth   │─►│ Logging │─►│ Metrics │─►│ Compress │ │   │
│  │  │ Limiter │  │ Verify  │  │         │  │         │  │          │ │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └──────────┘ │   │
│  │                                                                      │   │
│  └───────────────────────────────────┬─────────────────────────────────┘   │
│                                      │                                      │
│  ┌───────────────────────────────────▼─────────────────────────────────┐   │
│  │                       API ROUTERS                                    │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    REST API Router (/api/v1)                 │   │   │
│  │  │  /datasets  /users  /marketplace  /storage  /stream         │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    S3-Compatible Router                      │   │   │
│  │  │  PUT/GET/DELETE /bucket/object  (AWS Signature V4)          │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    gRPC Services                             │   │   │
│  │  │  DataService  StorageService  StreamService  AdminService   │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  └───────────────────────────────────┬─────────────────────────────────┘   │
│                                      │                                      │
│  ┌───────────────────────────────────▼─────────────────────────────────┐   │
│  │                       BACKEND CONNECTORS                             │   │
│  │                                                                      │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │  Storage     │  │  Metadata    │  │  Blockchain  │              │   │
│  │  │  Node Pool   │  │  Service     │  │  Client      │              │   │
│  │  │  (gRPC)      │  │  (Internal)  │  │  (Solana)    │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Core Services Detail

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CORE SERVICES                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────┐  ┌────────────────────────────────┐│
│  │      METADATA SERVICE              │  │      ROUTING SERVICE           ││
│  │                                    │  │                                ││
│  │  Responsibilities:                 │  │  Responsibilities:             ││
│  │  • CID → File mapping              │  │  • Find nearest nodes          ││
│  │  • File → Chunk mapping            │  │  • Load balancing              ││
│  │  • Schema storage                  │  │  • Geographic optimization     ││
│  │  • Version tracking                │  │  • Failover handling           ││
│  │                                    │  │                                ││
│  │  Storage: PostgreSQL + Redis       │  │  Storage: Redis (hot paths)    ││
│  │                                    │  │                                ││
│  │  ┌──────────────────────────────┐ │  │  ┌────────────────────────────┐││
│  │  │ file_metadata               │ │  │  │ node_locations             │││
│  │  │ ├─ cid: string (PK)         │ │  │  │ ├─ node_id: string        │││
│  │  │ ├─ name: string             │ │  │  │ ├─ region: string         │││
│  │  │ ├─ size: u64                │ │  │  │ ├─ latency_ms: u32        │││
│  │  │ ├─ chunk_count: u32         │ │  │  │ ├─ available_space: u64   │││
│  │  │ ├─ owner: pubkey            │ │  │  │ └─ last_seen: timestamp   │││
│  │  │ └─ created_at: timestamp    │ │  │  └────────────────────────────┘││
│  │  └──────────────────────────────┘ │  │                                ││
│  └────────────────────────────────────┘  └────────────────────────────────┘│
│                                                                              │
│  ┌────────────────────────────────────┐  ┌────────────────────────────────┐│
│  │      ERASURE SERVICE               │  │      REPAIR SERVICE            ││
│  │                                    │  │                                ││
│  │  Responsibilities:                 │  │  Responsibilities:             ││
│  │  • Encode files to shards          │  │  • Detect missing shards       ││
│  │  • Decode shards to files          │  │  • Reconstruct from k shards   ││
│  │  • Verify shard integrity          │  │  • Re-distribute repaired      ││
│  │                                    │  │  • Alert on failures           ││
│  │  Config:                           │  │                                ││
│  │  ┌──────────────────────────────┐ │  │  Triggers:                     ││
│  │  │ k = 10 (data shards)         │ │  │  • Node goes offline           ││
│  │  │ m = 4  (parity shards)       │ │  │  • Health check fails          ││
│  │  │ Total = 14 shards per file   │ │  │  • Periodic audit              ││
│  │  │ Fault tolerance = 4 nodes    │ │  │  • Manual trigger              ││
│  │  └──────────────────────────────┘ │  │                                ││
│  └────────────────────────────────────┘  └────────────────────────────────┘│
│                                                                              │
│  ┌────────────────────────────────────┐  ┌────────────────────────────────┐│
│  │      ACCESS CONTROL SERVICE        │  │      BILLING SERVICE           ││
│  │                                    │  │                                ││
│  │  Responsibilities:                 │  │  Responsibilities:             ││
│  │  • Verify ownership                │  │  • Track storage usage         ││
│  │  • Check permissions               │  │  • Track bandwidth usage       ││
│  │  • Token-gated access              │  │  • Calculate fees              ││
│  │  • Encryption key management       │  │  • Process payments            ││
│  │                                    │  │  • Generate invoices           ││
│  │  Permission Levels:                │  │                                ││
│  │  ┌──────────────────────────────┐ │  │  Pricing Model:                ││
│  │  │ NONE    = 0                  │ │  │  ┌────────────────────────────┐││
│  │  │ READ    = 1                  │ │  │  │ Storage: $0.004/GB/month   │││
│  │  │ WRITE   = 2                  │ │  │  │ Bandwidth: $0.01/GB        │││
│  │  │ DELETE  = 4                  │ │  │  │ Operations: $0.0001/1000   │││
│  │  │ ADMIN   = 7 (all)            │ │  │  └────────────────────────────┘││
│  │  └──────────────────────────────┘ │  │                                ││
│  └────────────────────────────────────┘  └────────────────────────────────┘│
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Network Topology

### 3.1 Global Distribution

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        GLOBAL NETWORK TOPOLOGY                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                              ┌─────────────┐                                │
│                              │   GLOBAL    │                                │
│                              │   DHT       │                                │
│                              │ (Kademlia)  │                                │
│                              └──────┬──────┘                                │
│                                     │                                        │
│         ┌───────────────────────────┼───────────────────────────┐           │
│         │                           │                           │           │
│         ▼                           ▼                           ▼           │
│  ┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐ │
│  │   AMERICAS      │        │     EUROPE      │        │   ASIA-PACIFIC  │ │
│  │   REGION        │        │     REGION      │        │   REGION        │ │
│  │                 │        │                 │        │                 │ │
│  │  ┌───────────┐  │        │  ┌───────────┐  │        │  ┌───────────┐  │ │
│  │  │ Gateway   │  │        │  │ Gateway   │  │        │  │ Gateway   │  │ │
│  │  │ us-east   │  │        │  │ eu-west   │  │        │  │ ap-east   │  │ │
│  │  └─────┬─────┘  │        │  └─────┬─────┘  │        │  └─────┬─────┘  │ │
│  │        │        │        │        │        │        │        │        │ │
│  │  ┌─────┴─────┐  │        │  ┌─────┴─────┐  │        │  ┌─────┴─────┐  │ │
│  │  │           │  │        │  │           │  │        │  │           │  │ │
│  │  ▼           ▼  │        │  ▼           ▼  │        │  ▼           ▼  │ │
│  │ ┌───┐     ┌───┐ │        │ ┌───┐     ┌───┐ │        │ ┌───┐     ┌───┐ │ │
│  │ │N1 │◄───►│N2 │ │◄──────►│ │N3 │◄───►│N4 │ │◄──────►│ │N5 │◄───►│N6 │ │ │
│  │ └───┘     └───┘ │        │ └───┘     └───┘ │        │ └───┘     └───┘ │ │
│  │   │         │   │        │   │         │   │        │   │         │   │ │
│  │   ▼         ▼   │        │   ▼         ▼   │        │   ▼         ▼   │ │
│  │ ┌───┐     ┌───┐ │        │ ┌───┐     ┌───┐ │        │ ┌───┐     ┌───┐ │ │
│  │ │N7 │◄───►│N8 │ │        │ │N9 │◄───►│N10│ │        │ │N11│◄───►│N12│ │ │
│  │ └───┘     └───┘ │        │ └───┘     └───┘ │        │ └───┘     └───┘ │ │
│  │                 │        │                 │        │                 │ │
│  │  Nodes: ~500    │        │  Nodes: ~800    │        │  Nodes: ~400    │ │
│  │  Storage: 2PB   │        │  Storage: 3PB   │        │  Storage: 1.5PB │ │
│  └─────────────────┘        └─────────────────┘        └─────────────────┘ │
│                                                                              │
│  Inter-Region Links: High-bandwidth, encrypted tunnels                      │
│  Intra-Region Links: libp2p P2P connections                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Node Communication Protocols

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        COMMUNICATION PROTOCOLS                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    PROTOCOL STACK                                    │   │
│  │                                                                      │   │
│  │    ┌─────────────────────────────────────────────────────────────┐  │   │
│  │    │  APPLICATION    │ CyxCloud Protocol (Request/Response)      │  │   │
│  │    ├─────────────────┼───────────────────────────────────────────┤  │   │
│  │    │  PRESENTATION   │ Protobuf Serialization                    │  │   │
│  │    ├─────────────────┼───────────────────────────────────────────┤  │   │
│  │    │  SESSION        │ libp2p Multiplexing (yamux/mplex)         │  │   │
│  │    ├─────────────────┼───────────────────────────────────────────┤  │   │
│  │    │  SECURITY       │ Noise Protocol / TLS 1.3                  │  │   │
│  │    ├─────────────────┼───────────────────────────────────────────┤  │   │
│  │    │  TRANSPORT      │ QUIC / TCP                                │  │   │
│  │    ├─────────────────┼───────────────────────────────────────────┤  │   │
│  │    │  NETWORK        │ IP (IPv4/IPv6)                            │  │   │
│  │    └─────────────────┴───────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    MESSAGE TYPES                                      │  │
│  │                                                                       │  │
│  │  ┌─────────────────┬─────────────────┬───────────────────────────┐  │  │
│  │  │ Type            │ Direction       │ Description               │  │  │
│  │  ├─────────────────┼─────────────────┼───────────────────────────┤  │  │
│  │  │ CHUNK_PUT       │ Client → Node   │ Store chunk data          │  │  │
│  │  │ CHUNK_GET       │ Client → Node   │ Retrieve chunk data       │  │  │
│  │  │ CHUNK_EXISTS    │ Client → Node   │ Check chunk existence     │  │  │
│  │  │ CHUNK_DELETE    │ Client → Node   │ Remove chunk (GC)         │  │  │
│  │  │ PEER_ANNOUNCE   │ Node ↔ Node     │ DHT peer announcement     │  │  │
│  │  │ PEER_FIND       │ Node ↔ Node     │ DHT peer lookup           │  │  │
│  │  │ HEARTBEAT       │ Node → Gateway  │ Health status report      │  │  │
│  │  │ REPAIR_REQUEST  │ Service → Node  │ Trigger shard repair      │  │  │
│  │  └─────────────────┴─────────────────┴───────────────────────────┘  │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Peer Discovery (Kademlia DHT)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        KADEMLIA DHT STRUCTURE                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Node ID: 256-bit (SHA-256 of public key)                                   │
│  XOR Distance: distance(A, B) = A ⊕ B                                       │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      ROUTING TABLE (K-Buckets)                         │ │
│  │                                                                        │ │
│  │  Node ID: 1010...1100 (256 bits)                                      │ │
│  │                                                                        │ │
│  │  Bucket 0 (distance 2^0):   [ peer_255 ]                  (1 entry)   │ │
│  │  Bucket 1 (distance 2^1):   [ peer_254, peer_253 ]        (2 entries) │ │
│  │  Bucket 2 (distance 2^2):   [ peer_252, peer_251, ... ]   (k entries) │ │
│  │  ...                                                                   │ │
│  │  Bucket 255 (distance 2^255): [ peer_1, peer_0, ... ]     (k entries) │ │
│  │                                                                        │ │
│  │  k = 20 (bucket size)                                                 │ │
│  │  α = 3  (concurrency parameter)                                       │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      LOOKUP ALGORITHM                                  │ │
│  │                                                                        │ │
│  │  find_nodes(target_id):                                               │ │
│  │    1. Select α closest nodes from routing table                       │ │
│  │    2. Send FIND_NODE(target_id) to selected nodes in parallel         │ │
│  │    3. Receive k closest nodes from each response                      │ │
│  │    4. Merge results, sort by XOR distance                             │ │
│  │    5. Repeat with new closest nodes until no improvement              │ │
│  │    6. Return k closest nodes to target_id                             │ │
│  │                                                                        │ │
│  │  put_value(key, value):                                               │ │
│  │    1. nodes = find_nodes(hash(key))                                   │ │
│  │    2. Send STORE(key, value) to all k nodes                           │ │
│  │                                                                        │ │
│  │  get_value(key):                                                      │ │
│  │    1. nodes = find_nodes(hash(key))                                   │ │
│  │    2. Send FIND_VALUE(key) to nodes                                   │ │
│  │    3. Return first valid value received                               │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Data Flow Architecture

### 4.1 Upload Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           UPLOAD DATA FLOW                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────┐                                                               │
│  │  Client  │                                                               │
│  │ (Engine) │                                                               │
│  └────┬─────┘                                                               │
│       │                                                                      │
│       │ 1. Upload Request                                                   │
│       │    POST /api/v1/datasets                                            │
│       │    Body: { name, size, encryption_key_hash }                        │
│       ▼                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         GATEWAY                                       │  │
│  │                                                                       │  │
│  │  2. Authenticate user (JWT/wallet signature)                         │  │
│  │  3. Check storage quota                                              │  │
│  │  4. Generate upload session ID                                       │  │
│  │  5. Return upload endpoints                                          │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│       ┌──────────────────────────────┘                                      │
│       │ 6. Stream encrypted chunks                                         │
│       │    PUT /upload/{session_id}/chunk/{index}                          │
│       ▼                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      ERASURE ENCODER                                  │  │
│  │                                                                       │  │
│  │  7. Receive chunk (1-4 MB)                                           │  │
│  │  8. Compute CID = hash(chunk_data)                                   │  │
│  │  9. Apply Reed-Solomon encoding:                                     │  │
│  │     ┌─────────────────────────────────────────────────────────────┐ │  │
│  │     │  Input: 1 chunk (e.g., 4 MB)                                 │ │  │
│  │     │  Output: 14 shards (10 data + 4 parity)                      │ │  │
│  │     │  Each shard: ~400 KB                                         │ │  │
│  │     └─────────────────────────────────────────────────────────────┘ │  │
│  │  10. Assign shards to nodes via Routing Service                     │  │
│  │                                                                       │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│       ┌──────────────────────────────┴──────────────────────────────┐      │
│       │                              │                              │      │
│       ▼                              ▼                              ▼      │
│  ┌──────────┐                  ┌──────────┐                  ┌──────────┐ │
│  │  Node 1  │                  │  Node 2  │        ...       │  Node 14 │ │
│  │          │                  │          │                  │          │ │
│  │ 11. PUT  │                  │ 11. PUT  │                  │ 11. PUT  │ │
│  │   shard  │                  │   shard  │                  │   shard  │ │
│  │          │                  │          │                  │          │ │
│  │ 12. ACK  │                  │ 12. ACK  │                  │ 12. ACK  │ │
│  └──────────┘                  └──────────┘                  └──────────┘ │
│       │                              │                              │      │
│       └──────────────────────────────┴──────────────────────────────┘      │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      METADATA SERVICE                                 │  │
│  │                                                                       │  │
│  │  13. Store file metadata:                                            │  │
│  │      { cid, name, size, chunk_cids[], shard_locations[], owner }    │  │
│  │                                                                       │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      BLOCKCHAIN (Solana)                              │  │
│  │                                                                       │  │
│  │  14. Register on-chain:                                              │  │
│  │      DataRegistry.register(cid, owner, merkle_root, size)           │  │
│  │                                                                       │  │
│  │  15. Return transaction signature                                    │  │
│  │                                                                       │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────┐                                                               │
│  │  Client  │◄── 16. Response: { cid, tx_sig, upload_stats }              │
│  └──────────┘                                                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Download Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          DOWNLOAD DATA FLOW                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────┐                                                               │
│  │  Client  │                                                               │
│  └────┬─────┘                                                               │
│       │                                                                      │
│       │ 1. GET /api/v1/datasets/{cid}                                       │
│       │    Header: Authorization: Bearer {token}                            │
│       ▼                                                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         GATEWAY                                       │  │
│  │                                                                       │  │
│  │  2. Verify authentication                                            │  │
│  │  3. Query Access Control Service                                     │  │
│  │                                                                       │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    ACCESS CONTROL SERVICE                             │  │
│  │                                                                       │  │
│  │  4. Check blockchain for ownership/permission                        │  │
│  │     - Is user the owner?                                             │  │
│  │     - Is user in allowed_readers[]?                                  │  │
│  │     - Does user hold required token?                                 │  │
│  │     - Did user purchase access?                                      │  │
│  │                                                                       │  │
│  │  5. If allowed, issue short-lived access token                       │  │
│  │                                                                       │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      METADATA SERVICE                                 │  │
│  │                                                                       │  │
│  │  6. Fetch file metadata                                              │  │
│  │     { chunk_cids[], shard_locations[], total_size }                  │  │
│  │                                                                       │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      ROUTING SERVICE                                  │  │
│  │                                                                       │  │
│  │  7. For each chunk, select optimal nodes:                            │  │
│  │     - Sort by latency to client                                      │  │
│  │     - Filter by availability status                                  │  │
│  │     - Select k nodes (need 10 of 14 shards)                          │  │
│  │                                                                       │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│       ┌──────────────────────────────┴──────────────────────────────┐      │
│       │                              │                              │      │
│       ▼                              ▼                              ▼      │
│  ┌──────────┐                  ┌──────────┐                  ┌──────────┐ │
│  │  Node A  │                  │  Node B  │        ...       │  Node K  │ │
│  │          │                  │          │                  │          │ │
│  │ 8. GET   │                  │ 8. GET   │                  │ 8. GET   │ │
│  │   shard  │                  │   shard  │                  │   shard  │ │
│  │          │                  │          │                  │          │ │
│  │ 9. Return│                  │ 9. Return│                  │ 9. Return│ │
│  │   shard  │                  │   shard  │                  │   shard  │ │
│  └──────────┘                  └──────────┘                  └──────────┘ │
│       │                              │                              │      │
│       └──────────────────────────────┴──────────────────────────────┘      │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      ERASURE DECODER                                  │  │
│  │                                                                       │  │
│  │  10. Collect k=10 shards (any 10 of 14)                              │  │
│  │  11. Apply Reed-Solomon decoding                                     │  │
│  │  12. Verify CID matches hash(decoded_chunk)                          │  │
│  │  13. Stream chunk to client                                          │  │
│  │                                                                       │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────┐                                                               │
│  │  Client  │◄── 14. Stream: encrypted chunk data                         │
│  │          │                                                               │
│  │  15. Decrypt with user's key                                           │
│  │  16. Write to local storage                                            │
│  └──────────┘                                                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 ML Training Data Flow (CyxWiz Integration)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ML TRAINING DATA FLOW                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────┐                        ┌────────────────┐                   │
│  │   CyxWiz   │  1. Submit Job         │    Central     │                   │
│  │   Engine   │───────────────────────►│    Server      │                   │
│  │            │     {model, data_cid}  │                │                   │
│  └────────────┘                        └───────┬────────┘                   │
│                                                │                             │
│                                    2. Find optimal node                     │
│                                       (prefer data locality)                │
│                                                │                             │
│                                                ▼                             │
│                                        ┌────────────────┐                   │
│                                        │  Server Node   │                   │
│                                        │  (Compute)     │                   │
│                                        └───────┬────────┘                   │
│                                                │                             │
│                              3. Request data by CID                         │
│                                                │                             │
│                                                ▼                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         CYXCLOUD STREAMING                            │  │
│  │                                                                       │  │
│  │  4. Create StreamingLoader:                                          │  │
│  │     ┌─────────────────────────────────────────────────────────────┐ │  │
│  │     │  loader = StreamingLoader(cid, {                             │ │  │
│  │     │      batch_size: 32,                                         │ │  │
│  │     │      prefetch_batches: 4,                                    │ │  │
│  │     │      shuffle_buffer: 1000,                                   │ │  │
│  │     │      cache_size_mb: 1024                                     │ │  │
│  │     │  })                                                          │ │  │
│  │     └─────────────────────────────────────────────────────────────┘ │  │
│  │                                                                       │  │
│  │  5. Prefetch Pipeline:                                               │  │
│  │                                                                       │  │
│  │    ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐            │  │
│  │    │ Batch   │──►│ Decode  │──►│ LRU     │──►│ GPU     │            │  │
│  │    │ Fetcher │   │ Shards  │   │ Cache   │   │ Queue   │            │  │
│  │    │ (async) │   │         │   │         │   │         │            │  │
│  │    └─────────┘   └─────────┘   └─────────┘   └─────────┘            │  │
│  │         │                                          │                 │  │
│  │         │        Background I/O                    │                 │  │
│  │         └──────────────────────────────────────────┘                 │  │
│  │                                                                       │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│                             6. Stream batches                              │
│                                      │                                      │
│                                      ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         SERVER NODE                                   │  │
│  │                                                                       │  │
│  │  7. Training Loop:                                                   │  │
│  │     for batch in loader:                                             │  │
│  │         loss = model.forward(batch)                                  │  │
│  │         loss.backward()                                              │  │
│  │         optimizer.step()                                             │  │
│  │         report_progress()                                            │  │
│  │                                                                       │  │
│  │  8. Cache hit rate: ~95% after warmup                                │  │
│  │                                                                       │  │
│  └───────────────────────────────────┬──────────────────────────────────┘  │
│                                      │                                      │
│                           9. Report completion                             │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────┐                ┌────────────────┐                          │
│  │   CyxWiz   │◄───────────────│    Central     │                          │
│  │   Engine   │  10. Results   │    Server      │                          │
│  └────────────┘                └────────────────┘                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Storage Architecture

### 5.1 Chunk Storage Model

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CHUNK STORAGE MODEL                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      FILE → CHUNK → SHARD                              │ │
│  │                                                                        │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │ │
│  │  │                    Original File (100 MB)                        │  │ │
│  │  │                    CID: QmFile123...                             │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  │                              │                                         │ │
│  │                              │ Split by chunk_size (4 MB)             │ │
│  │                              ▼                                         │ │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐    25       │ │
│  │  │Chunk 0 │ │Chunk 1 │ │Chunk 2 │ │Chunk 3 │ │Chunk 4 │   chunks    │ │
│  │  │  4MB   │ │  4MB   │ │  4MB   │ │  4MB   │ │  4MB   │   ...       │ │
│  │  │QmC0... │ │QmC1... │ │QmC2... │ │QmC3... │ │QmC4... │             │ │
│  │  └────┬───┘ └────┬───┘ └────┬───┘ └────┬───┘ └────┬───┘             │ │
│  │       │          │          │          │          │                  │ │
│  │       │          │    Reed-Solomon (k=10, m=4)    │                  │ │
│  │       │          │          │          │          │                  │ │
│  │       ▼          ▼          ▼          ▼          ▼                  │ │
│  │  ┌───────────────────────────────────────────────────────────────┐  │ │
│  │  │  Each chunk becomes 14 shards:                                 │  │ │
│  │  │                                                                │  │ │
│  │  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ... ┌─────┐ ┌─────┐ │  │ │
│  │  │  │ S0  │ │ S1  │ │ S2  │ │ S3  │ │ S4  │     │ S12 │ │ S13 │ │  │ │
│  │  │  │DATA │ │DATA │ │DATA │ │DATA │ │DATA │     │PARI │ │PARI │ │  │ │
│  │  │  │400KB│ │400KB│ │400KB│ │400KB│ │400KB│     │400KB│ │400KB│ │  │ │
│  │  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘     └─────┘ └─────┘ │  │ │
│  │  │                                                                │  │ │
│  │  │  Total: 14 × 400 KB = 5.6 MB (1.4× overhead)                  │  │ │
│  │  └───────────────────────────────────────────────────────────────┘  │ │
│  │                              │                                         │ │
│  │                              │ Distribute to different nodes          │ │
│  │                              ▼                                         │ │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ... ┌─────┐ ┌─────┐        │ │
│  │  │Node1│ │Node2│ │Node3│ │Node4│ │Node5│     │Node13││Node14│        │ │
│  │  │ S0  │ │ S1  │ │ S2  │ │ S3  │ │ S4  │     │ S12 │ │ S13 │        │ │
│  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘     └─────┘ └─────┘        │ │
│  │                                                                        │ │
│  │  Rule: No two shards of same chunk on same node                       │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Content Identifier (CID) Structure

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CID STRUCTURE                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  CID v1 Format (IPFS-compatible):                                           │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <multibase><version><multicodec><multihash>                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  Example:                                                                    │
│  bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi                │
│  │    │                                                                      │
│  │    └── Base32 encoded                                                    │
│  └─────── "bafy" prefix = CIDv1 + dag-pb + sha2-256                        │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      CID BREAKDOWN                                     │ │
│  │                                                                        │ │
│  │  Field         │ Value          │ Description                         │ │
│  │  ──────────────┼────────────────┼───────────────────────────────────  │ │
│  │  multibase     │ 'b' (0x62)     │ Base32 lower encoding               │ │
│  │  version       │ 0x01           │ CID version 1                       │ │
│  │  multicodec    │ 0x71           │ dag-cbor (our data format)          │ │
│  │  multihash     │ 0x12 + 0x20    │ sha2-256, 32 bytes                  │ │
│  │  hash          │ <32 bytes>     │ SHA-256 of content                  │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      CID GENERATION                                    │ │
│  │                                                                        │ │
│  │  fn generate_cid(data: &[u8]) -> Cid {                                │ │
│  │      let hash = blake3::hash(data);  // or sha2-256                   │ │
│  │      let multihash = Multihash::wrap(BLAKE3, hash.as_bytes());        │ │
│  │      Cid::new_v1(DAG_CBOR, multihash)                                 │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  URI Format:                                                                 │
│  cyx://QmXXX.../path/to/file                                                │
│  cyx://QmXXX...                     (root CID)                              │
│  cyx://QmXXX.../train/images/       (directory)                             │
│  cyx://QmXXX.../train/labels.csv    (file within dataset)                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 Local Storage Layout (Storage Node)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      LOCAL STORAGE LAYOUT                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  /var/cyxcloud/                                                             │
│  │                                                                           │
│  ├── config.toml              # Node configuration                          │
│  │                                                                           │
│  ├── identity/                                                              │
│  │   ├── node_id              # 256-bit node ID                            │
│  │   ├── private_key.pem      # Ed25519 private key                        │
│  │   └── public_key.pem       # Ed25519 public key                         │
│  │                                                                           │
│  ├── data/                    # RocksDB chunk storage                       │
│  │   ├── chunks/              # Main chunk data                             │
│  │   │   ├── 000001.sst       # SST files                                  │
│  │   │   ├── 000002.sst                                                    │
│  │   │   ├── MANIFEST-000003                                               │
│  │   │   └── CURRENT                                                       │
│  │   │                                                                      │
│  │   └── index/               # CID → location index                       │
│  │       ├── bloom.bin        # Bloom filter for fast lookup               │
│  │       └── lsm/             # LSM tree index                             │
│  │                                                                           │
│  ├── metadata/                # SQLite/sled metadata DB                     │
│  │   ├── meta.db              # Chunk metadata                              │
│  │   └── meta.db-wal          # Write-ahead log                            │
│  │                                                                           │
│  ├── cache/                   # Hot data cache (optional SSD)               │
│  │   └── lru/                 # LRU eviction                                │
│  │                                                                           │
│  ├── temp/                    # Temporary files                             │
│  │   └── uploads/             # In-progress uploads                         │
│  │                                                                           │
│  └── logs/                    # Application logs                            │
│      ├── node.log                                                           │
│      └── node.log.1                                                         │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  Chunk Key Format (RocksDB):                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Key:   <shard_cid>                   (32 bytes)                    │   │
│  │  Value: <shard_data>                  (variable, typically ~400KB)  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  Metadata Schema (SQLite):                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  CREATE TABLE shards (                                              │   │
│  │      shard_cid    BLOB PRIMARY KEY,     -- 32 bytes                │   │
│  │      chunk_cid    BLOB NOT NULL,        -- Parent chunk CID        │   │
│  │      shard_index  INTEGER NOT NULL,     -- 0-13                    │   │
│  │      size_bytes   INTEGER NOT NULL,                                │   │
│  │      stored_at    INTEGER NOT NULL,     -- Unix timestamp          │   │
│  │      last_access  INTEGER,              -- For LRU                 │   │
│  │      verified_at  INTEGER               -- Last integrity check    │   │
│  │  );                                                                │   │
│  │                                                                     │   │
│  │  CREATE INDEX idx_chunk ON shards(chunk_cid);                      │   │
│  │  CREATE INDEX idx_access ON shards(last_access);                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Security Architecture

### 6.1 Encryption Model

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ENCRYPTION MODEL                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      ZERO-KNOWLEDGE ARCHITECTURE                       │ │
│  │                                                                        │ │
│  │  Client-side encryption: Storage nodes NEVER see plaintext data       │ │
│  │                                                                        │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐│ │
│  │  │                      KEY HIERARCHY                                ││ │
│  │  │                                                                   ││ │
│  │  │         ┌─────────────────┐                                      ││ │
│  │  │         │   Master Key    │  ◄─── Derived from user password     ││ │
│  │  │         │   (Never sent)  │       via Argon2id                   ││ │
│  │  │         └────────┬────────┘                                      ││ │
│  │  │                  │                                                ││ │
│  │  │         ┌────────▼────────┐                                      ││ │
│  │  │         │  Key Encryption │  ◄─── Used to encrypt DEKs           ││ │
│  │  │         │  Key (KEK)      │       AES-256-GCM                    ││ │
│  │  │         └────────┬────────┘                                      ││ │
│  │  │                  │                                                ││ │
│  │  │    ┌─────────────┼─────────────┐                                 ││ │
│  │  │    │             │             │                                 ││ │
│  │  │    ▼             ▼             ▼                                 ││ │
│  │  │ ┌─────┐       ┌─────┐       ┌─────┐                             ││ │
│  │  │ │DEK 1│       │DEK 2│       │DEK N│  ◄─── Per-file keys         ││ │
│  │  │ │     │       │     │       │     │       Random 256-bit        ││ │
│  │  │ └──┬──┘       └──┬──┘       └──┬──┘                             ││ │
│  │  │    │             │             │                                 ││ │
│  │  │    ▼             ▼             ▼                                 ││ │
│  │  │ ┌─────┐       ┌─────┐       ┌─────┐                             ││ │
│  │  │ │File1│       │File2│       │FileN│  ◄─── Encrypted with DEK   ││ │
│  │  │ └─────┘       └─────┘       └─────┘       AES-256-GCM           ││ │
│  │  │                                                                   ││ │
│  │  └───────────────────────────────────────────────────────────────────┘│ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      ENCRYPTION PROCESS                                │ │
│  │                                                                        │ │
│  │  1. User uploads file                                                 │ │
│  │  2. Client generates random DEK (256-bit)                             │ │
│  │  3. Client encrypts file: ciphertext = AES-256-GCM(file, DEK, nonce) │ │
│  │  4. Client encrypts DEK: encrypted_dek = AES-256-GCM(DEK, KEK)       │ │
│  │  5. Client sends: { ciphertext, encrypted_dek, nonce }               │ │
│  │  6. Server stores ciphertext, never sees plaintext                   │ │
│  │                                                                        │ │
│  │  Decryption (client-side only):                                       │ │
│  │  1. Download { ciphertext, encrypted_dek, nonce }                    │ │
│  │  2. Decrypt DEK using KEK                                             │ │
│  │  3. Decrypt file using DEK                                            │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Authentication & Authorization

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     AUTHENTICATION & AUTHORIZATION                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      AUTHENTICATION METHODS                            │ │
│  │                                                                        │ │
│  │  Method 1: Wallet Signature (Primary - Web3)                          │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐│ │
│  │  │  1. Server sends challenge: { nonce, timestamp, domain }         ││ │
│  │  │  2. Client signs with Solana wallet: sign(challenge, privkey)    ││ │
│  │  │  3. Server verifies: verify(signature, challenge, pubkey)        ││ │
│  │  │  4. Server issues JWT with claims: { sub: pubkey, exp, iat }     ││ │
│  │  └──────────────────────────────────────────────────────────────────┘│ │
│  │                                                                        │ │
│  │  Method 2: API Key (Machine-to-Machine)                               │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐│ │
│  │  │  Header: Authorization: Bearer <api_key>                         ││ │
│  │  │  API key format: cyx_<base64(pubkey)>_<random_secret>           ││ │
│  │  │  Rate limited per key, scoped permissions                        ││ │
│  │  └──────────────────────────────────────────────────────────────────┘│ │
│  │                                                                        │ │
│  │  Method 3: OAuth 2.0 (Enterprise SSO)                                 │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐│ │
│  │  │  Supported providers: Okta, Azure AD, Google Workspace           ││ │
│  │  │  Maps SSO identity to CyxCloud account                           ││ │
│  │  └──────────────────────────────────────────────────────────────────┘│ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      AUTHORIZATION MODEL (RBAC + ABAC)                 │ │
│  │                                                                        │ │
│  │  ┌────────────────────────────────────────────────────────────────┐  │ │
│  │  │                    PERMISSION MATRIX                            │  │ │
│  │  │                                                                 │  │ │
│  │  │  Resource      │ Owner │ Admin │ Write │ Read │ Public        │  │ │
│  │  │  ──────────────┼───────┼───────┼───────┼──────┼───────────── │  │ │
│  │  │  Read file     │   ✓   │   ✓   │   ✓   │  ✓   │ if public    │  │ │
│  │  │  Write file    │   ✓   │   ✓   │   ✓   │  ✗   │     ✗        │  │ │
│  │  │  Delete file   │   ✓   │   ✓   │   ✗   │  ✗   │     ✗        │  │ │
│  │  │  Share file    │   ✓   │   ✓   │   ✗   │  ✗   │     ✗        │  │ │
│  │  │  Modify ACL    │   ✓   │   ✓   │   ✗   │  ✗   │     ✗        │  │ │
│  │  │  Transfer      │   ✓   │   ✗   │   ✗   │  ✗   │     ✗        │  │ │
│  │  │                                                                 │  │ │
│  │  └────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                        │ │
│  │  On-chain ACL (Solana):                                               │ │
│  │  ┌────────────────────────────────────────────────────────────────┐  │ │
│  │  │  struct DatasetAccess {                                         │  │ │
│  │  │      owner: Pubkey,                                             │  │ │
│  │  │      admins: Vec<Pubkey>,                                       │  │ │
│  │  │      writers: Vec<Pubkey>,                                      │  │ │
│  │  │      readers: Vec<Pubkey>,                                      │  │ │
│  │  │      public_read: bool,                                         │  │ │
│  │  │      token_gated: Option<TokenGate>,                            │  │ │
│  │  │  }                                                              │  │ │
│  │  │                                                                 │  │ │
│  │  │  struct TokenGate {                                             │  │ │
│  │  │      token_mint: Pubkey,                                        │  │ │
│  │  │      min_balance: u64,                                          │  │ │
│  │  │  }                                                              │  │ │
│  │  └────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.3 Network Security

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        NETWORK SECURITY                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      TLS CONFIGURATION                                 │ │
│  │                                                                        │ │
│  │  Protocol:     TLS 1.3 only                                           │ │
│  │  Ciphers:      TLS_AES_256_GCM_SHA384, TLS_CHACHA20_POLY1305_SHA256  │ │
│  │  Key Exchange: X25519, secp256r1                                      │ │
│  │  Certificates: Let's Encrypt (auto-renewed)                           │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      P2P SECURITY (libp2p)                             │ │
│  │                                                                        │ │
│  │  ┌────────────────────────────────────────────────────────────────┐  │ │
│  │  │  1. Noise Protocol Framework                                    │  │ │
│  │  │     - XX handshake pattern                                      │  │ │
│  │  │     - Ed25519 identity keys                                     │  │ │
│  │  │     - Mutual authentication                                     │  │ │
│  │  │                                                                 │  │ │
│  │  │  2. Peer ID Verification                                        │  │ │
│  │  │     - PeerId = hash(public_key)                                 │  │ │
│  │  │     - Verify peer presents matching key                         │  │ │
│  │  │                                                                 │  │ │
│  │  │  3. Message Signing                                             │  │ │
│  │  │     - All messages signed with node's Ed25519 key              │  │ │
│  │  │     - Prevents spoofing and MITM                               │  │ │
│  │  └────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      RATE LIMITING                                     │ │
│  │                                                                        │ │
│  │  ┌────────────────────────────────────────────────────────────────┐  │ │
│  │  │  Endpoint              │ Limit (per minute)  │ Burst           │  │ │
│  │  │  ─────────────────────┼────────────────────┼──────────────── │  │ │
│  │  │  POST /upload          │ 100                 │ 20              │  │ │
│  │  │  GET /download         │ 1000                │ 100             │  │ │
│  │  │  GET /metadata         │ 5000                │ 500             │  │ │
│  │  │  POST /search          │ 200                 │ 50              │  │ │
│  │  │  S3 operations         │ 10000               │ 1000            │  │ │
│  │  │                                                                 │  │ │
│  │  │  Algorithm: Token bucket with sliding window                   │  │ │
│  │  │  Storage: Redis (distributed rate limiting)                    │  │ │
│  │  └────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. API Specifications

### 7.1 REST API

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           REST API v1                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Base URL: https://api.cyxcloud.io/v1                                       │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      DATASETS ENDPOINTS                                │ │
│  │                                                                        │ │
│  │  POST   /datasets                   Create/upload dataset             │ │
│  │  GET    /datasets/{cid}             Get dataset metadata              │ │
│  │  GET    /datasets/{cid}/download    Download dataset                  │ │
│  │  DELETE /datasets/{cid}             Delete dataset                    │ │
│  │  PATCH  /datasets/{cid}             Update metadata                   │ │
│  │  POST   /datasets/{cid}/share       Share dataset                     │ │
│  │                                                                        │ │
│  │  GET    /datasets/{cid}/versions    List versions                     │ │
│  │  POST   /datasets/{cid}/versions    Create new version                │ │
│  │  GET    /datasets/{cid}/lineage     Get data lineage                  │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      STREAMING ENDPOINTS                               │ │
│  │                                                                        │ │
│  │  GET    /stream/{cid}               Stream dataset chunks             │ │
│  │         ?batch_size=32                                                 │ │
│  │         &offset=0                                                      │ │
│  │         &limit=1000                                                    │ │
│  │         &shuffle=true                                                  │ │
│  │                                                                        │ │
│  │  POST   /stream/prefetch            Prefetch hints                    │ │
│  │         { cid, chunk_indices[] }                                       │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      USER ENDPOINTS                                    │ │
│  │                                                                        │ │
│  │  GET    /users/me                   Get current user                  │ │
│  │  GET    /users/me/datasets          List user's datasets              │ │
│  │  GET    /users/me/usage             Get usage stats                   │ │
│  │  GET    /users/me/billing           Get billing info                  │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      MARKETPLACE ENDPOINTS                             │ │
│  │                                                                        │ │
│  │  GET    /marketplace/search         Search datasets                   │ │
│  │         ?q=image+classification                                        │ │
│  │         &min_size=1GB                                                  │ │
│  │         &max_price=100                                                 │ │
│  │                                                                        │ │
│  │  POST   /marketplace/purchase       Purchase dataset access           │ │
│  │         { cid, payment_tx }                                            │ │
│  │                                                                        │ │
│  │  POST   /marketplace/list           List dataset for sale             │ │
│  │         { cid, price, license }                                        │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      EXAMPLE: UPLOAD FLOW                              │ │
│  │                                                                        │ │
│  │  // 1. Initialize upload                                              │ │
│  │  POST /datasets                                                       │ │
│  │  {                                                                     │ │
│  │      "name": "my-dataset",                                            │ │
│  │      "size": 1073741824,                                              │ │
│  │      "content_type": "application/octet-stream",                      │ │
│  │      "encryption": "aes-256-gcm"                                      │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  │  Response: {                                                          │ │
│  │      "upload_id": "up_123abc",                                        │ │
│  │      "upload_urls": [                                                 │ │
│  │          { "part": 1, "url": "https://..." },                         │ │
│  │          { "part": 2, "url": "https://..." }                          │ │
│  │      ],                                                                │ │
│  │      "expires_at": "2024-12-10T12:00:00Z"                            │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  │  // 2. Upload parts (parallel)                                        │ │
│  │  PUT {upload_urls[0].url}                                             │ │
│  │  Body: <chunk_data>                                                   │ │
│  │                                                                        │ │
│  │  // 3. Complete upload                                                │ │
│  │  POST /datasets/{upload_id}/complete                                  │ │
│  │  {                                                                     │ │
│  │      "parts": [                                                       │ │
│  │          { "part": 1, "etag": "abc123" },                             │ │
│  │          { "part": 2, "etag": "def456" }                              │ │
│  │      ]                                                                 │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  │  Response: {                                                          │ │
│  │      "cid": "QmXXX...",                                               │ │
│  │      "size": 1073741824,                                              │ │
│  │      "tx_signature": "5abc..."                                        │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 gRPC API (Internal)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           gRPC API (Proto3)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  // cyxcloud/data.proto                                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  syntax = "proto3";                                                    │ │
│  │  package cyxcloud;                                                     │ │
│  │                                                                        │ │
│  │  service DataService {                                                 │ │
│  │      // Metadata operations                                            │ │
│  │      rpc GetMetadata(GetMetadataRequest) returns (DatasetMetadata);   │ │
│  │      rpc ListChunks(ListChunksRequest) returns (ChunkList);           │ │
│  │                                                                        │ │
│  │      // Data streaming                                                 │ │
│  │      rpc StreamData(StreamRequest) returns (stream DataChunk);        │ │
│  │      rpc UploadChunks(stream DataChunk) returns (UploadResponse);     │ │
│  │                                                                        │ │
│  │      // Prefetch hints                                                 │ │
│  │      rpc Prefetch(PrefetchRequest) returns (PrefetchResponse);        │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  │  message DatasetMetadata {                                             │ │
│  │      string cid = 1;                                                   │ │
│  │      string name = 2;                                                  │ │
│  │      uint64 size = 3;                                                  │ │
│  │      uint32 chunk_count = 4;                                           │ │
│  │      string owner = 5;                                                 │ │
│  │      int64 created_at = 6;                                             │ │
│  │      DataSchema schema = 7;                                            │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  │  message DataChunk {                                                   │ │
│  │      string cid = 1;                                                   │ │
│  │      uint32 index = 2;                                                 │ │
│  │      bytes data = 3;                                                   │ │
│  │      uint64 offset = 4;                                                │ │
│  │      bool is_last = 5;                                                 │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  │  message StreamRequest {                                               │ │
│  │      string dataset_cid = 1;                                           │ │
│  │      uint64 offset = 2;                                                │ │
│  │      uint64 limit = 3;                                                 │ │
│  │      uint32 batch_size = 4;                                            │ │
│  │      bool shuffle = 5;                                                 │ │
│  │      uint64 shuffle_seed = 6;                                          │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  // cyxcloud/storage.proto                                                  │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  service StorageService {                                              │ │
│  │      // Node-to-node shard operations                                  │ │
│  │      rpc PutShard(PutShardRequest) returns (PutShardResponse);        │ │
│  │      rpc GetShard(GetShardRequest) returns (ShardData);               │ │
│  │      rpc DeleteShard(DeleteShardRequest) returns (DeleteResponse);    │ │
│  │      rpc VerifyShard(VerifyRequest) returns (VerifyResponse);         │ │
│  │                                                                        │ │
│  │      // Health and metrics                                             │ │
│  │      rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);     │ │
│  │      rpc GetStats(StatsRequest) returns (NodeStats);                  │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  │  message PutShardRequest {                                             │ │
│  │      string shard_cid = 1;                                             │ │
│  │      string chunk_cid = 2;                                             │ │
│  │      uint32 shard_index = 3;                                           │ │
│  │      bytes data = 4;                                                   │ │
│  │      uint32 replication_factor = 5;                                    │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  │  message NodeStats {                                                   │ │
│  │      string node_id = 1;                                               │ │
│  │      uint64 total_storage = 2;                                         │ │
│  │      uint64 used_storage = 3;                                          │ │
│  │      uint64 shard_count = 4;                                           │ │
│  │      double uptime_percent = 5;                                        │ │
│  │      uint32 avg_latency_ms = 6;                                        │ │
│  │  }                                                                     │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 S3-Compatible API

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        S3-COMPATIBLE API                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Endpoint: https://s3.cyxcloud.io                                           │
│  Authentication: AWS Signature V4                                           │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      SUPPORTED OPERATIONS                              │ │
│  │                                                                        │ │
│  │  BUCKETS:                                                              │ │
│  │  ├── PUT    /{bucket}              CreateBucket                       │ │
│  │  ├── DELETE /{bucket}              DeleteBucket                       │ │
│  │  ├── GET    /{bucket}              ListObjects                        │ │
│  │  ├── HEAD   /{bucket}              HeadBucket                         │ │
│  │  └── GET    /                      ListBuckets                        │ │
│  │                                                                        │ │
│  │  OBJECTS:                                                              │ │
│  │  ├── PUT    /{bucket}/{key}        PutObject                          │ │
│  │  ├── GET    /{bucket}/{key}        GetObject                          │ │
│  │  ├── DELETE /{bucket}/{key}        DeleteObject                       │ │
│  │  ├── HEAD   /{bucket}/{key}        HeadObject                         │ │
│  │  └── COPY   /{bucket}/{key}        CopyObject                         │ │
│  │                                                                        │ │
│  │  MULTIPART:                                                            │ │
│  │  ├── POST   /{bucket}/{key}?uploads           InitiateMultipart      │ │
│  │  ├── PUT    /{bucket}/{key}?partNumber&uploadId  UploadPart          │ │
│  │  ├── POST   /{bucket}/{key}?uploadId          CompleteMultipart      │ │
│  │  └── DELETE /{bucket}/{key}?uploadId          AbortMultipart         │ │
│  │                                                                        │ │
│  │  PRESIGNED:                                                            │ │
│  │  └── GET/PUT with X-Amz-Signature             Presigned URLs          │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      CID MAPPING                                       │ │
│  │                                                                        │ │
│  │  S3 Path                    │  CyxCloud CID                           │ │
│  │  ──────────────────────────┼─────────────────────────────────────── │ │
│  │  /my-bucket/path/to/file    │  cyx://QmBucket.../path/to/file        │ │
│  │  /datasets/mnist.zip        │  cyx://QmDatasets.../mnist.zip          │ │
│  │                                                                        │ │
│  │  Bucket CID = hash(owner_pubkey + bucket_name)                        │ │
│  │  Object CID = hash(file_content)                                      │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Database Schema

### 8.1 PostgreSQL (Metadata Service)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        POSTGRESQL SCHEMA                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      CORE TABLES                                       │ │
│  │                                                                        │ │
│  │  -- Users (linked to Solana wallet)                                   │ │
│  │  CREATE TABLE users (                                                 │ │
│  │      id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),      │ │
│  │      wallet_address  VARCHAR(44) UNIQUE NOT NULL,  -- Solana pubkey  │ │
│  │      email           VARCHAR(255),                                    │ │
│  │      created_at      TIMESTAMPTZ DEFAULT NOW(),                       │ │
│  │      storage_quota   BIGINT DEFAULT 5368709120,  -- 5 GB default     │ │
│  │      storage_used    BIGINT DEFAULT 0                                 │ │
│  │  );                                                                   │ │
│  │                                                                        │ │
│  │  -- Datasets (files/directories)                                      │ │
│  │  CREATE TABLE datasets (                                              │ │
│  │      cid             VARCHAR(64) PRIMARY KEY,      -- IPFS CID       │ │
│  │      owner_id        UUID REFERENCES users(id),                       │ │
│  │      name            VARCHAR(255) NOT NULL,                           │ │
│  │      description     TEXT,                                            │ │
│  │      size_bytes      BIGINT NOT NULL,                                 │ │
│  │      chunk_count     INTEGER NOT NULL,                                │ │
│  │      content_type    VARCHAR(128),                                    │ │
│  │      encryption_type VARCHAR(32) DEFAULT 'aes-256-gcm',              │ │
│  │      is_public       BOOLEAN DEFAULT FALSE,                           │ │
│  │      created_at      TIMESTAMPTZ DEFAULT NOW(),                       │ │
│  │      updated_at      TIMESTAMPTZ DEFAULT NOW(),                       │ │
│  │      merkle_root     BYTEA NOT NULL,               -- For integrity  │ │
│  │      tx_signature    VARCHAR(88)                   -- Solana tx      │ │
│  │  );                                                                   │ │
│  │                                                                        │ │
│  │  -- Chunks (individual pieces of a dataset)                           │ │
│  │  CREATE TABLE chunks (                                                │ │
│  │      cid             VARCHAR(64) PRIMARY KEY,                         │ │
│  │      dataset_cid     VARCHAR(64) REFERENCES datasets(cid),           │ │
│  │      chunk_index     INTEGER NOT NULL,                                │ │
│  │      size_bytes      INTEGER NOT NULL,                                │ │
│  │      shard_count     INTEGER DEFAULT 14,                              │ │
│  │      UNIQUE(dataset_cid, chunk_index)                                 │ │
│  │  );                                                                   │ │
│  │                                                                        │ │
│  │  -- Shard locations (which node stores which shard)                   │ │
│  │  CREATE TABLE shard_locations (                                       │ │
│  │      id              BIGSERIAL PRIMARY KEY,                           │ │
│  │      shard_cid       VARCHAR(64) NOT NULL,                            │ │
│  │      chunk_cid       VARCHAR(64) REFERENCES chunks(cid),             │ │
│  │      shard_index     INTEGER NOT NULL,             -- 0-13           │ │
│  │      node_id         VARCHAR(64) NOT NULL,                            │ │
│  │      stored_at       TIMESTAMPTZ DEFAULT NOW(),                       │ │
│  │      verified_at     TIMESTAMPTZ,                                     │ │
│  │      UNIQUE(chunk_cid, shard_index, node_id)                          │ │
│  │  );                                                                   │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      ACCESS CONTROL TABLES                             │ │
│  │                                                                        │ │
│  │  -- Dataset permissions                                               │ │
│  │  CREATE TABLE dataset_permissions (                                   │ │
│  │      id              BIGSERIAL PRIMARY KEY,                           │ │
│  │      dataset_cid     VARCHAR(64) REFERENCES datasets(cid),           │ │
│  │      user_id         UUID REFERENCES users(id),                       │ │
│  │      permission      VARCHAR(16) NOT NULL,  -- read, write, admin    │ │
│  │      granted_at      TIMESTAMPTZ DEFAULT NOW(),                       │ │
│  │      granted_by      UUID REFERENCES users(id),                       │ │
│  │      expires_at      TIMESTAMPTZ,                                     │ │
│  │      UNIQUE(dataset_cid, user_id)                                     │ │
│  │  );                                                                   │ │
│  │                                                                        │ │
│  │  -- Share links                                                       │ │
│  │  CREATE TABLE share_links (                                           │ │
│  │      id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),      │ │
│  │      dataset_cid     VARCHAR(64) REFERENCES datasets(cid),           │ │
│  │      token           VARCHAR(64) UNIQUE NOT NULL,                     │ │
│  │      permission      VARCHAR(16) DEFAULT 'read',                      │ │
│  │      password_hash   VARCHAR(128),                                    │ │
│  │      max_downloads   INTEGER,                                         │ │
│  │      download_count  INTEGER DEFAULT 0,                               │ │
│  │      expires_at      TIMESTAMPTZ,                                     │ │
│  │      created_at      TIMESTAMPTZ DEFAULT NOW()                        │ │
│  │  );                                                                   │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      VERSIONING TABLES                                 │ │
│  │                                                                        │ │
│  │  -- Dataset versions                                                  │ │
│  │  CREATE TABLE dataset_versions (                                      │ │
│  │      id              BIGSERIAL PRIMARY KEY,                           │ │
│  │      dataset_cid     VARCHAR(64) REFERENCES datasets(cid),           │ │
│  │      version_tag     VARCHAR(64) NOT NULL,         -- v1.0.0         │ │
│  │      parent_cid      VARCHAR(64),                  -- Previous ver   │ │
│  │      message         TEXT,                         -- Commit msg     │ │
│  │      created_at      TIMESTAMPTZ DEFAULT NOW(),                       │ │
│  │      created_by      UUID REFERENCES users(id),                       │ │
│  │      UNIQUE(dataset_cid, version_tag)                                 │ │
│  │  );                                                                   │ │
│  │                                                                        │ │
│  │  -- Data lineage                                                      │ │
│  │  CREATE TABLE data_lineage (                                          │ │
│  │      id              BIGSERIAL PRIMARY KEY,                           │ │
│  │      dataset_cid     VARCHAR(64) REFERENCES datasets(cid),           │ │
│  │      source_cid      VARCHAR(64),                  -- Parent data    │ │
│  │      transform_type  VARCHAR(64),                  -- anonymize, etc │ │
│  │      transform_script VARCHAR(64),                 -- Script CID     │ │
│  │      operator        UUID REFERENCES users(id),                       │ │
│  │      timestamp       TIMESTAMPTZ DEFAULT NOW(),                       │ │
│  │      metadata        JSONB                                            │ │
│  │  );                                                                   │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      INDEXES                                           │ │
│  │                                                                        │ │
│  │  CREATE INDEX idx_datasets_owner ON datasets(owner_id);              │ │
│  │  CREATE INDEX idx_chunks_dataset ON chunks(dataset_cid);             │ │
│  │  CREATE INDEX idx_shards_node ON shard_locations(node_id);           │ │
│  │  CREATE INDEX idx_shards_chunk ON shard_locations(chunk_cid);        │ │
│  │  CREATE INDEX idx_permissions_user ON dataset_permissions(user_id);  │ │
│  │  CREATE INDEX idx_lineage_dataset ON data_lineage(dataset_cid);      │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Redis (Caching & Real-time)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           REDIS SCHEMA                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      KEY PATTERNS                                      │ │
│  │                                                                        │ │
│  │  // Session tokens                                                    │ │
│  │  session:{session_id}          → { user_id, expires_at, scopes }     │ │
│  │  TTL: 24 hours                                                        │ │
│  │                                                                        │ │
│  │  // Rate limiting                                                     │ │
│  │  ratelimit:{user_id}:{endpoint} → count                              │ │
│  │  TTL: 60 seconds (sliding window)                                     │ │
│  │                                                                        │ │
│  │  // Node health                                                       │ │
│  │  node:{node_id}:health         → { status, last_seen, metrics }      │ │
│  │  TTL: 5 minutes                                                       │ │
│  │                                                                        │ │
│  │  // Node routing (sorted set by latency)                              │ │
│  │  nodes:region:{region}         → ZSET { node_id: latency_score }     │ │
│  │                                                                        │ │
│  │  // Hot metadata cache                                                │ │
│  │  metadata:{cid}                → { name, size, owner, ... }          │ │
│  │  TTL: 1 hour                                                          │ │
│  │                                                                        │ │
│  │  // Shard location cache                                              │ │
│  │  shards:{chunk_cid}            → [ { node_id, shard_idx }, ... ]     │ │
│  │  TTL: 15 minutes                                                      │ │
│  │                                                                        │ │
│  │  // Upload sessions                                                   │ │
│  │  upload:{upload_id}            → { user_id, parts[], status }        │ │
│  │  TTL: 24 hours                                                        │ │
│  │                                                                        │ │
│  │  // Pub/Sub channels                                                  │ │
│  │  channel:node:health           → Node health updates                 │ │
│  │  channel:repair:jobs           → Repair job notifications            │ │
│  │  channel:billing:events        → Billing events                      │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Protocol Specifications

### 9.1 Chunk Protocol

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CHUNK WIRE PROTOCOL                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      MESSAGE FORMAT                                    │ │
│  │                                                                        │ │
│  │  All messages are length-prefixed Protobuf:                           │ │
│  │                                                                        │ │
│  │  ┌──────────┬──────────────────────────────────────────────────────┐ │ │
│  │  │  Length  │                    Protobuf Message                   │ │ │
│  │  │ (4 bytes)│                     (variable)                        │ │ │
│  │  │  u32 BE  │                                                       │ │ │
│  │  └──────────┴──────────────────────────────────────────────────────┘ │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      PUT SHARD FLOW                                    │ │
│  │                                                                        │ │
│  │  Client                                    Node                        │ │
│  │    │                                         │                         │ │
│  │    │─── PUT_SHARD_REQUEST ──────────────────►│                         │ │
│  │    │    {                                    │                         │ │
│  │    │      shard_cid: bytes[32],              │                         │ │
│  │    │      chunk_cid: bytes[32],              │                         │ │
│  │    │      shard_index: u8,                   │                         │ │
│  │    │      data: bytes[],                     │                         │ │
│  │    │      signature: bytes[64]               │                         │ │
│  │    │    }                                    │                         │ │
│  │    │                                         │                         │ │
│  │    │◄── PUT_SHARD_RESPONSE ─────────────────│                         │ │
│  │    │    {                                    │                         │ │
│  │    │      status: OK | ERROR,                │                         │ │
│  │    │      stored_at: timestamp               │                         │ │
│  │    │    }                                    │                         │ │
│  │    │                                         │                         │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      GET SHARD FLOW                                    │ │
│  │                                                                        │ │
│  │  Client                                    Node                        │ │
│  │    │                                         │                         │ │
│  │    │─── GET_SHARD_REQUEST ──────────────────►│                         │ │
│  │    │    {                                    │                         │ │
│  │    │      shard_cid: bytes[32],              │                         │ │
│  │    │      access_token: bytes[]              │                         │ │
│  │    │    }                                    │                         │ │
│  │    │                                         │                         │ │
│  │    │◄── GET_SHARD_RESPONSE ─────────────────│                         │ │
│  │    │    {                                    │                         │ │
│  │    │      status: OK | NOT_FOUND | DENIED,   │                         │ │
│  │    │      data: bytes[],                     │                         │ │
│  │    │      proof: MerkleProof                 │                         │ │
│  │    │    }                                    │                         │ │
│  │    │                                         │                         │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 Heartbeat Protocol

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        HEARTBEAT PROTOCOL                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      HEARTBEAT MESSAGE                                 │ │
│  │                                                                        │ │
│  │  Node → Coordinator (every 30 seconds):                               │ │
│  │                                                                        │ │
│  │  message Heartbeat {                                                  │ │
│  │      string node_id = 1;                                              │ │
│  │      uint64 timestamp = 2;                                            │ │
│  │      bytes signature = 3;  // Sign(node_id + timestamp)              │ │
│  │                                                                        │ │
│  │      // Capacity                                                      │ │
│  │      uint64 total_storage_bytes = 4;                                  │ │
│  │      uint64 used_storage_bytes = 5;                                   │ │
│  │      uint64 available_bandwidth_bps = 6;                              │ │
│  │                                                                        │ │
│  │      // Performance                                                   │ │
│  │      uint32 avg_latency_ms = 7;                                       │ │
│  │      uint32 requests_per_minute = 8;                                  │ │
│  │      double cpu_usage_percent = 9;                                    │ │
│  │      double memory_usage_percent = 10;                                │ │
│  │                                                                        │ │
│  │      // Health                                                        │ │
│  │      uint64 shard_count = 11;                                         │ │
│  │      uint32 failed_requests = 12;                                     │ │
│  │      repeated string peer_ids = 13;  // Connected peers              │ │
│  │  }                                                                    │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      NODE STATUS STATE MACHINE                         │ │
│  │                                                                        │ │
│  │                     ┌──────────────────┐                               │ │
│  │                     │                  │                               │ │
│  │          ┌──────────▼──────────┐       │ heartbeat received           │ │
│  │          │      ONLINE         │───────┘                               │ │
│  │          │  (accepting data)   │                                       │ │
│  │          └──────────┬──────────┘                                       │ │
│  │                     │                                                  │ │
│  │                     │ no heartbeat for 60s                            │ │
│  │                     ▼                                                  │ │
│  │          ┌─────────────────────┐                                       │ │
│  │          │      WARNING        │                                       │ │
│  │          │  (stop new writes)  │                                       │ │
│  │          └──────────┬──────────┘                                       │ │
│  │                     │                                                  │ │
│  │                     │ no heartbeat for 5min                           │ │
│  │                     ▼                                                  │ │
│  │          ┌─────────────────────┐                                       │ │
│  │          │      OFFLINE        │                                       │ │
│  │          │  (trigger repair)   │                                       │ │
│  │          └─────────────────────┘                                       │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. Deployment Architecture

### 10.1 Infrastructure Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DEPLOYMENT ARCHITECTURE                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      MANAGED SERVICES (Cloud)                          │ │
│  │                                                                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │ │
│  │  │   AWS/GCP   │  │  Cloudflare │  │  PostgreSQL │  │    Redis    │  │ │
│  │  │   Load      │  │     CDN     │  │   (RDS/     │  │ (Elasticache│  │ │
│  │  │  Balancer   │  │             │  │   Cloud)    │  │  /Upstash)  │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      GATEWAY CLUSTER (Kubernetes)                      │ │
│  │                                                                        │ │
│  │  Region: us-east-1                 Region: eu-west-1                  │ │
│  │  ┌─────────────────────┐           ┌─────────────────────┐            │ │
│  │  │ gateway-us-east     │           │ gateway-eu-west     │            │ │
│  │  │ ├── pod-1 (2 CPU)   │           │ ├── pod-1 (2 CPU)   │            │ │
│  │  │ ├── pod-2 (2 CPU)   │           │ ├── pod-2 (2 CPU)   │            │ │
│  │  │ └── pod-3 (2 CPU)   │           │ └── pod-3 (2 CPU)   │            │ │
│  │  └─────────────────────┘           └─────────────────────┘            │ │
│  │                                                                        │ │
│  │  Scaling: HPA (CPU > 70%, Requests > 10k/min)                         │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      COORDINATOR (Central Server)                      │ │
│  │                                                                        │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │                    CyxWiz Central Server                         │ │ │
│  │  │                                                                  │ │ │
│  │  │  Primary: central-1.cyxwiz.io (Active)                          │ │ │
│  │  │  Standby: central-2.cyxwiz.io (Hot Standby)                     │ │ │
│  │  │                                                                  │ │ │
│  │  │  Features:                                                       │ │ │
│  │  │  - Node registry                                                 │ │ │
│  │  │  - Job scheduling                                                │ │ │
│  │  │  - CyxCloud coordination                                         │ │ │
│  │  │                                                                  │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      STORAGE NODES (Decentralized)                     │ │
│  │                                                                        │ │
│  │  Provider-operated (home, datacenter, cloud)                          │ │
│  │                                                                        │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │ │
│  │  │  Home   │ │  Home   │ │  VPS    │ │Datacenter│ │  Cloud  │        │ │
│  │  │  NAS    │ │  Server │ │ Hetzner │ │  Rack   │ │   VM    │        │ │
│  │  │  1TB    │ │  4TB    │ │  10TB   │ │  100TB  │ │  50TB   │        │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │ │
│  │                                                                        │ │
│  │  Total Network: ~1700 nodes, ~6.5 PB storage                          │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.2 Docker Compose (Development)

```yaml
┌─────────────────────────────────────────────────────────────────────────────┐
│                        docker-compose.yml                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  version: '3.8'                                                             │
│                                                                              │
│  services:                                                                  │
│    gateway:                                                                 │
│      build: ./cyxcloud-gateway                                              │
│      ports:                                                                 │
│        - "8080:8080"    # REST API                                          │
│        - "50051:50051"  # gRPC                                              │
│      environment:                                                           │
│        - DATABASE_URL=postgres://cyxcloud:pass@postgres:5432/cyxcloud      │
│        - REDIS_URL=redis://redis:6379                                       │
│        - SOLANA_RPC=https://api.devnet.solana.com                          │
│      depends_on:                                                            │
│        - postgres                                                           │
│        - redis                                                              │
│                                                                              │
│    storage-node:                                                            │
│      build: ./cyxcloud-node                                                 │
│      ports:                                                                 │
│        - "4001:4001"    # libp2p                                            │
│        - "50052:50052"  # gRPC                                              │
│      volumes:                                                               │
│        - ./data/storage:/var/cyxcloud/data                                 │
│      environment:                                                           │
│        - GATEWAY_URL=http://gateway:8080                                   │
│        - ALLOCATED_STORAGE=10GB                                            │
│                                                                              │
│    postgres:                                                                │
│      image: postgres:15                                                     │
│      environment:                                                           │
│        - POSTGRES_USER=cyxcloud                                            │
│        - POSTGRES_PASSWORD=pass                                            │
│        - POSTGRES_DB=cyxcloud                                              │
│      volumes:                                                               │
│        - ./data/postgres:/var/lib/postgresql/data                          │
│                                                                              │
│    redis:                                                                   │
│      image: redis:7-alpine                                                  │
│      volumes:                                                               │
│        - ./data/redis:/data                                                │
│                                                                              │
│    solana-validator:                                                        │
│      image: solanalabs/solana:v1.17                                        │
│      command: solana-test-validator                                         │
│      ports:                                                                 │
│        - "8899:8899"    # RPC                                               │
│        - "8900:8900"    # Websocket                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 11. Scalability & Performance

### 11.1 Performance Targets

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        PERFORMANCE TARGETS                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      SLA TARGETS                                       │ │
│  │                                                                        │ │
│  │  Metric                    │ Target        │ Measurement              │ │
│  │  ─────────────────────────┼───────────────┼───────────────────────── │ │
│  │  Availability              │ 99.9%         │ Monthly uptime           │ │
│  │  Upload latency (p50)      │ < 100ms       │ Time to first byte       │ │
│  │  Upload latency (p99)      │ < 500ms       │ Time to first byte       │ │
│  │  Download latency (p50)    │ < 50ms        │ Time to first byte       │ │
│  │  Download latency (p99)    │ < 200ms       │ Time to first byte       │ │
│  │  Throughput (single file)  │ > 100 MB/s    │ Large file download      │ │
│  │  Throughput (aggregate)    │ > 10 Gbps     │ Total network            │ │
│  │  Data durability           │ 99.999999999% │ 11 nines                 │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      CAPACITY PLANNING                                 │ │
│  │                                                                        │ │
│  │  Year 1:                                                               │ │
│  │  ├── Storage nodes: 100-500                                            │ │
│  │  ├── Total capacity: 500 TB - 2 PB                                    │ │
│  │  ├── Active users: 1,000 - 10,000                                     │ │
│  │  └── Daily uploads: 10 TB                                             │ │
│  │                                                                        │ │
│  │  Year 3:                                                               │ │
│  │  ├── Storage nodes: 2,000 - 10,000                                    │ │
│  │  ├── Total capacity: 10 PB - 50 PB                                    │ │
│  │  ├── Active users: 100,000+                                           │ │
│  │  └── Daily uploads: 500 TB                                            │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 11.2 Scaling Strategies

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        SCALING STRATEGIES                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      HORIZONTAL SCALING                                │ │
│  │                                                                        │ │
│  │  Gateway Layer:                                                        │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │  Load ───► Auto-scale gateway pods                               │ │ │
│  │  │           (Kubernetes HPA)                                        │ │ │
│  │  │                                                                   │ │ │
│  │  │  Strategy:                                                        │ │ │
│  │  │  - Scale up when CPU > 70% or RPS > threshold                   │ │ │
│  │  │  - Scale down after 5 min of low usage                          │ │ │
│  │  │  - Min: 3 pods, Max: 50 pods per region                         │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                        │ │
│  │  Storage Layer:                                                        │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │  Demand ───► Incentivize new storage providers                   │ │ │
│  │  │              (Dynamic pricing)                                    │ │ │
│  │  │                                                                   │ │ │
│  │  │  Strategy:                                                        │ │ │
│  │  │  - If utilization > 80%, increase rewards                       │ │ │
│  │  │  - Geographic bonuses for underserved regions                   │ │ │
│  │  │  - Automated onboarding for new nodes                           │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                        │ │
│  │  Database Layer:                                                       │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │  Load ───► Read replicas + Sharding                              │ │ │
│  │  │                                                                   │ │ │
│  │  │  Strategy:                                                        │ │ │
│  │  │  - Read queries → Replicas (round-robin)                        │ │ │
│  │  │  - Write queries → Primary                                       │ │ │
│  │  │  - Shard by owner_id if needed (future)                         │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      CACHING STRATEGY                                  │ │
│  │                                                                        │ │
│  │  Layer 1: Client-side cache                                           │ │
│  │  ├── LRU cache for recently accessed chunks                          │ │
│  │  ├── Configurable size (default: 1 GB)                               │ │
│  │  └── Cache hit: 0 latency                                            │ │
│  │                                                                        │ │
│  │  Layer 2: Edge cache (CDN)                                            │ │
│  │  ├── Cloudflare/Fastly for static content                            │ │
│  │  ├── TTL: 1 hour for public data                                     │ │
│  │  └── Cache hit: < 20ms                                               │ │
│  │                                                                        │ │
│  │  Layer 3: Gateway cache (Redis)                                       │ │
│  │  ├── Metadata cache (15 min TTL)                                     │ │
│  │  ├── Routing cache (5 min TTL)                                       │ │
│  │  └── Cache hit: < 5ms                                                │ │
│  │                                                                        │ │
│  │  Layer 4: Storage node cache                                          │ │
│  │  ├── Hot chunks on SSD                                               │ │
│  │  ├── LRU eviction                                                    │ │
│  │  └── Cache hit: < 10ms                                               │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 12. Monitoring & Observability

### 12.1 Metrics

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        MONITORING METRICS                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      GATEWAY METRICS                                   │ │
│  │                                                                        │ │
│  │  # Request metrics                                                    │ │
│  │  cyxcloud_gateway_requests_total{method, endpoint, status}           │ │
│  │  cyxcloud_gateway_request_duration_seconds{method, endpoint}         │ │
│  │  cyxcloud_gateway_request_size_bytes{method, endpoint}               │ │
│  │                                                                        │ │
│  │  # Throughput                                                         │ │
│  │  cyxcloud_gateway_bytes_uploaded_total                               │ │
│  │  cyxcloud_gateway_bytes_downloaded_total                             │ │
│  │                                                                        │ │
│  │  # Rate limiting                                                      │ │
│  │  cyxcloud_gateway_rate_limited_total{user_id}                        │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      STORAGE NODE METRICS                              │ │
│  │                                                                        │ │
│  │  # Capacity                                                           │ │
│  │  cyxcloud_node_storage_total_bytes{node_id}                          │ │
│  │  cyxcloud_node_storage_used_bytes{node_id}                           │ │
│  │  cyxcloud_node_shard_count{node_id}                                  │ │
│  │                                                                        │ │
│  │  # Performance                                                        │ │
│  │  cyxcloud_node_request_latency_seconds{node_id, operation}           │ │
│  │  cyxcloud_node_requests_total{node_id, operation, status}            │ │
│  │                                                                        │ │
│  │  # Health                                                             │ │
│  │  cyxcloud_node_uptime_seconds{node_id}                               │ │
│  │  cyxcloud_node_last_heartbeat_timestamp{node_id}                     │ │
│  │  cyxcloud_node_peer_count{node_id}                                   │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      NETWORK METRICS                                   │ │
│  │                                                                        │ │
│  │  # DHT                                                                │ │
│  │  cyxcloud_dht_peers_total                                            │ │
│  │  cyxcloud_dht_routing_table_size                                     │ │
│  │  cyxcloud_dht_lookup_duration_seconds                                │ │
│  │                                                                        │ │
│  │  # Erasure coding                                                     │ │
│  │  cyxcloud_erasure_encode_duration_seconds                            │ │
│  │  cyxcloud_erasure_decode_duration_seconds                            │ │
│  │  cyxcloud_erasure_repair_total                                       │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 12.2 Alerting Rules

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ALERTING RULES                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  # Critical Alerts (Page immediately)                                       │
│                                                                              │
│  - alert: HighErrorRate                                                     │
│    expr: rate(cyxcloud_gateway_requests_total{status="5xx"}[5m]) > 0.01    │
│    for: 2m                                                                  │
│    severity: critical                                                       │
│                                                                              │
│  - alert: NodeOffline                                                       │
│    expr: time() - cyxcloud_node_last_heartbeat_timestamp > 300             │
│    for: 5m                                                                  │
│    severity: critical                                                       │
│                                                                              │
│  - alert: DataLossRisk                                                      │
│    expr: cyxcloud_chunk_available_shards < 10                              │
│    for: 1m                                                                  │
│    severity: critical                                                       │
│                                                                              │
│  # Warning Alerts (Notify during business hours)                            │
│                                                                              │
│  - alert: HighLatency                                                       │
│    expr: histogram_quantile(0.99, cyxcloud_gateway_request_duration) > 1   │
│    for: 10m                                                                 │
│    severity: warning                                                        │
│                                                                              │
│  - alert: StorageCapacityLow                                                │
│    expr: cyxcloud_network_storage_available_bytes < 1e12  # < 1TB          │
│    for: 30m                                                                 │
│    severity: warning                                                        │
│                                                                              │
│  - alert: HighRepairRate                                                    │
│    expr: rate(cyxcloud_erasure_repair_total[1h]) > 100                     │
│    for: 15m                                                                 │
│    severity: warning                                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Appendix A: Glossary

| Term | Definition |
|------|------------|
| **CID** | Content Identifier - hash-based address for data |
| **Chunk** | Fixed-size piece of a file (1-4 MB) |
| **Shard** | Erasure-coded piece of a chunk (14 per chunk) |
| **DHT** | Distributed Hash Table - peer discovery |
| **k** | Number of data shards (10) |
| **m** | Number of parity shards (4) |
| **DEK** | Data Encryption Key |
| **KEK** | Key Encryption Key |

---

## Appendix B: Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0.0 | Dec 2024 | CyxWiz Team | Initial architecture blueprint |

---

## References

1. [IPFS Technical Specification](https://github.com/ipfs/specs)
2. [libp2p Specification](https://github.com/libp2p/specs)
3. [Reed-Solomon Erasure Coding](https://en.wikipedia.org/wiki/Reed%E2%80%93Solomon_error_correction)
4. [Solana Developer Documentation](https://docs.solana.com/)
5. [AWS S3 API Reference](https://docs.aws.amazon.com/AmazonS3/latest/API/)
6. [CyxCloud Design Document](./cyxcloud.md)
